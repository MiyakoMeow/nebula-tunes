name: Rust
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
jobs:
  native:
    runs-on: ${{ matrix.os }}
    continue-on-error: true
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - uses: actions/checkout@v6
      - name: Setup rustfmt and clippy
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy
      - if: matrix.os == 'ubuntu-latest'
        name: Install system dependencies (Ubuntu)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libasound2-dev \
            pkg-config \
            libavutil-dev \
            libavcodec-dev \
            libavformat-dev \
            libavdevice-dev \
            libavfilter-dev \
            libswscale-dev \
            libswresample-dev \
            libpostproc-dev \
            ffmpeg
      - if: matrix.os == 'windows-latest'
        name: Install ffmpeg and llvm (Windows)
        run: |
          # Install scoop if not already installed
          if (-not (Get-Command scoop -ErrorAction SilentlyContinue)) {
            Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
            irm get.scoop.sh | iex
          }
          # Install ffmpeg-shared and llvm using scoop
          scoop install ffmpeg-shared llvm
          scoop shim scoop shims --delete
          # Set environment variables
          $ffmpegPath = scoop prefix ffmpeg-shared
          $llvmPath = scoop prefix llvm
          echo "LIBCLANG_PATH=$llvmPath\bin" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "FFMPEG_DIR=$ffmpegPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "$ffmpegPath\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      - if: matrix.os == 'macos-latest'
        name: Install ffmpeg dev libraries (macOS)
        run: brew install ffmpeg
      - name: Cache cargo build
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
          workspaces: |
            . -> target
      - name: Build crate
        run: cargo build --verbose
      - name: Format Check
        run: cargo fmt --check
      - name: "Clippy Check"
        run: cargo clippy --all-targets --verbose -- -D warnings
      - name: Test crate
        run: cargo test --verbose --all-features
  wasi:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Setup rustfmt and clippy
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy
          targets: wasm32-wasip1
      - name: Cache cargo build
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
          workspaces: |
            . -> target
      - name: Build crate (WASI)
        run: cargo build-wasm --verbose
      - name: Format Check
        run: cargo fmt --check
      - name: "Clippy Check (WASI)"
        if: false
        run: cargo clippy-wasm --verbose -- -D warnings
