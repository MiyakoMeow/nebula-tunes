name: Rust
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
jobs:
  native:
    runs-on: ${{ matrix.os }}
    continue-on-error: true
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            vcpkg-triplet: x64-linux
          - os: windows-latest
            vcpkg-triplet: x64-windows-static
          - os: macos-latest
            vcpkg-triplet: x64-osx
    steps:
      - uses: actions/checkout@v6
      - name: Setup rustfmt and clippy
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy
      - name: Install nasm (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y nasm
      - name: Install nasm (macOS)
        if: matrix.os == 'macos-latest'
        run: brew install nasm
      - name: Run vcpkg
        uses: lukka/run-vcpkg@v11
        env:
          VCPKG_DEFAULT_TRIPLET: ${{ matrix.vcpkg-triplet }}
        with:
          vcpkgJsonGlob: '**/vcpkg.json'
          vcpkgConfigurationJsonGlob: '**/vcpkg-configuration.json'
          doNotCache: false
          runVcpkgInstall: true
      - name: Setup vcpkg environment variables
        shell: bash
        run: |
          echo "VCPKG_ROOT=$VCPKG_ROOT" >> $GITHUB_ENV
          echo "VCPKG_DEFAULT_TRIPLET=${{ matrix.vcpkg-triplet }}" >> $GITHUB_ENV

          # 设置 pkg-config 路径（vcpkg 安装的库包含 .pc 文件）
          if [ "$RUNNER_OS" != "Windows" ]; then
            echo "$VCPKG_ROOT/installed/${{ matrix.vcpkg-triplet }}/lib/pkgconfig" >> $GITHUB_PATH
            echo "$VCPKG_ROOT/installed/${{ matrix.vcpkg-triplet }}/share/pkgconfig" >> $GITHUB_PATH
            export PKG_CONFIG_PATH="$VCPKG_ROOT/installed/${{ matrix.vcpkg-triplet }}/lib/pkgconfig:$VCPKG_ROOT/installed/${{ matrix.vcpkg-triplet }}/share/pkgconfig"
            echo "PKG_CONFIG_PATH=$PKG_CONFIG_PATH" >> $GITHUB_ENV
          fi

          # Windows 特殊配置
          if [ "$RUNNER_OS" == "Windows" ]; then
            echo "LIBCLANG_PATH=$VCPKG_ROOT/installed/${{ matrix.vcpkg-triplet }}/bin" >> $GITHUB_ENV
            echo "FFMPEG_DIR=$VCPKG_ROOT/installed/${{ matrix.vcpkg-triplet }}" >> $GITHUB_ENV
            echo "$VCPKG_ROOT/installed/${{ matrix.vcpkg-triplet }}/bin" >> $GITHUB_PATH
          else
            echo "FFMPEG_DIR=$VCPKG_ROOT/installed/${{ matrix.vcpkg-triplet }}" >> $GITHUB_ENV
          fi

          # 验证库已安装
          echo "=== Verifying vcpkg installation ==="
          ls -la "$VCPKG_ROOT/installed/${{ matrix.vcpkg-triplet }}/include/libavcodec"
          ls -la "$VCPKG_ROOT/installed/${{ matrix.vcpkg-triplet }}/lib" | grep -i ffmpeg || echo "ffmpeg libraries check"
      - name: Cache cargo build
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
          workspaces: |
            . -> target
      - name: Build crate
        env:
          FFMPEG_DIR: ${{ env.FFMPEG_DIR }}
          LIBCLANG_PATH: ${{ env.LIBCLANG_PATH }}
          PKG_CONFIG_PATH: ${{ env.PKG_CONFIG_PATH }}
          PKG_CONFIG_LIBDIR: ${{ env.PKG_CONFIG_PATH }}
        run: cargo build --verbose
      - name: Format Check
        run: cargo fmt --check
      - name: "Clippy Check"
        run: cargo clippy --all-targets --verbose -- -D warnings
      - name: Test crate
        run: cargo test --verbose --all-features
  wasi:
    if: false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Setup rustfmt and clippy
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy
          targets: wasm32-wasip1
      - name: Cache cargo build
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
          workspaces: |
            . -> target
      - name: Build crate (WASI)
        run: cargo build-wasm --verbose
      - name: Format Check
        run: cargo fmt --check
      - name: "Clippy Check (WASI)"
        if: false
        run: cargo clippy-wasm --verbose -- -D warnings
