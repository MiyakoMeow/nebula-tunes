name: Update vcpkg Dependencies

on:
  schedule:
    # 每月 1 号 UTC 00:00 运行
    - cron: '0 0 1 * *'
  workflow_dispatch: # 允许手动触发

jobs:
  update-vcpkg:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Get latest vcpkg commit
        id: vcpkg-commit
        run: |
          echo "Fetching latest vcpkg commit..."
          LATEST_COMMIT=$(git ls-remote https://github.com/microsoft/vcpkg.git HEAD | awk '{print $1}')
          echo "commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
          echo "Latest vcpkg commit: $LATEST_COMMIT"

      - name: Generate branch name with timestamp
        id: branch-name
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%d-%H%M%S")
          BRANCH_NAME="update/vcpkg-${TIMESTAMP}"
          echo "name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Generated branch name: $BRANCH_NAME"

      - name: Update vcpkg-configuration.json
        run: |
          LATEST_COMMIT="${{ steps.vcpkg-commit.outputs.commit }}"
          jq --arg commit "$LATEST_COMMIT" \
            '.default-registry.baseline = $commit' \
            vcpkg-configuration.json > vcpkg-configuration.json.tmp
          mv vcpkg-configuration.json.tmp vcpkg-configuration.json
          echo "Updated baseline to: $LATEST_COMMIT"

      - name: Check for changes
        id: check-changes
        run: |
          if [[ -n $(git diff --name-only) ]]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changed files:"
            git diff --name-only
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          fi

      - name: Commit changes
        if: steps.check-changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b ${{ steps.branch-name.outputs.name }}
          git add vcpkg-configuration.json
          git commit -m "chore: update vcpkg baseline

          - Update vcpkg baseline to ${{ steps.vcpkg-commit.outputs.commit }}"

      - name: Push branch
        if: steps.check-changes.outputs.changed == 'true'
        run: |
          git push origin ${{ steps.branch-name.outputs.name }}

      - name: Create Pull Request
        id: create-pr
        if: steps.check-changes.outputs.changed == 'true'
        run: |
          PR_NUMBER=$(gh pr create \
            --title "chore: update vcpkg baseline" \
            --body "## Summary

          This PR updates vcpkg baseline to the latest version.

          ### Changes
          - **vcpkg baseline**: \`${{ steps.vcpkg-commit.outputs.commit }}\`
          - **Branch**: \`${{ steps.branch-name.outputs.name }}\`

          ### Automated
          This PR was automatically created by the [Update vcpkg Dependencies](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) workflow.

          ---" \
            --base main \
            --head ${{ steps.branch-name.outputs.name }} \
            --label "dependencies" \
            --label "automated")
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "Created PR #$PR_NUMBER"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for CI checks
        if: steps.check-changes.outputs.changed == 'true'
        run: |
          PR_NUMBER="${{ steps.create-pr.outputs.number }}"
          echo "Waiting for CI checks on PR #$PR_NUMBER..."

          # 等待最多 60 分钟（3600 秒）
          TIMEOUT=3600
          ELAPSED=0
          INTERVAL=30

          while [ $ELAPSED -lt $TIMEOUT ]; do
            # 获取 PR 的 CI 状态
            CI_STATUS=$(gh pr view $PR_NUMBER --json statusCheckRollup -q '.statusCheckRollup[0].status' 2>/dev/null || echo "PENDING")

            echo "Current CI status: $CI_STATUS (elapsed: ${ELAPSED}s)"

            case "$CI_STATUS" in
              "COMPLETED")
                echo "CI checks completed!"
                break
                ;;
              "FAILED"|"FAILURE")
                echo "CI checks failed!"
                exit 1
                ;;
              *)
                echo "Still waiting..."
                sleep $INTERVAL
                ELAPSED=$((ELAPSED + INTERVAL))
                ;;
            esac
          done

          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "Timeout waiting for CI checks"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check CI result and merge
        if: steps.check-changes.outputs.changed == 'true'
        run: |
          PR_NUMBER="${{ steps.create-pr.outputs.number }}"

          # 检查所有 CI 是否通过
          CI_RESULT=$(gh pr view $PR_NUMBER --json statusCheckRollup -q '.statusCheckRollup[] | select(.status == "COMPLETED") | .conclusion' | grep -v "FAILURE" | head -n 1)

          if [[ "$CI_RESULT" == "SUCCESS" ]] || [[ -z "$(gh pr view $PR_NUMBER --json statusCheckRollup -q '.statusCheckRollup[] | select(.conclusion == "FAILURE")')" ]]; then
            echo "All CI checks passed! Merging PR #$PR_NUMBER..."
            gh pr merge $PR_NUMBER --merge --delete-branch
            echo "PR merged successfully"
          else
            echo "Some CI checks failed. PR will not be merged."
            gh pr view $PR_NUMBER --json statusCheckRollup
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        if: steps.check-changes.outputs.changed == 'true'
        run: |
          echo "## vcpkg Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **vcpkg baseline**: \`${{ steps.vcpkg-commit.outputs.commit }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ steps.branch-name.outputs.name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Pull Request**: #${{ steps.create-pr.outputs.number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ PR was created and merged automatically after CI passed." >> $GITHUB_STEP_SUMMARY

      - name: No changes summary
        if: steps.check-changes.outputs.changed == 'false'
        run: |
          echo "## vcpkg Update Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No changes detected. vcpkg baseline is already up to date." >> $GITHUB_STEP_SUMMARY
